services:
  yottadb:
    image: yottadb/yottadb-base:latest-master
    container_name: pakana-yottadb
    hostname: pakana-node
    ports:
      - "127.0.0.1:9080:9080" # YottaDB port
    volumes:
      - yottadb-data:/data
    environment:
      - ydb_dir=/data
      - ydb_rel=r2.03_x86_64
      - ydb_gbldir=/data/r2.03_x86_64/g/yottadb.gld
      - ydb_routines=/data/r2.03_x86_64/o/utf8 /data/r2.03_x86_64/r /data/r2.03_x86_64/o /opt/yottadb/current/plugin/o/utf8 /opt/yottadb/current/plugin/r /opt/yottadb/current/plugin/o
      - ydb_dist=/opt/yottadb/current
      - ydb_nodename=pakana-node
      - ydb_tmp=/data/tmp
      - GTM_TMP=/data/tmp
    ipc: host
    entrypoint: /bin/bash
    command: >
      -c "source /opt/yottadb/current/ydb_env_set && export ydb_tmp=/data/tmp && export GTM_TMP=/data/tmp && /opt/yottadb/current/ydb -run %XCMD 'hang 31536000'"
    restart: always

  api-go:
    build:
      context: ../api-go
    container_name: pakana-api-go
    hostname: pakana-node
    depends_on:
      - yottadb
    environment:
      - ydb_dir=/data
      - ydb_rel=r2.03_x86_64
      - ydb_gbldir=/data/r2.03_x86_64/g/yottadb.gld
      - ydb_routines=/data/r2.03_x86_64/o/utf8 /data/r2.03_x86_64/r /data/r2.03_x86_64/o /opt/yottadb/current/plugin/o/utf8 /opt/yottadb/current/plugin/r /data/r2.03_x86_64/o /opt/yottadb/current/libyottadbutil.so /opt/yottadb/current/libyottadb.so /opt/yottadb/current
      - ydb_ci=/opt/yottadb/current/plugin/octo/ydbocto.ci
      - ydb_dist=/opt/yottadb/current
      - ydb_nodename=pakana-node
      - ydb_tmp=/data/tmp
      - GTM_TMP=/data/tmp
    ipc: host
    volumes:
      - yottadb-data:/data
    restart: always

  core-rust:
    build:
      context: ../core-rust
    container_name: pakana-core-rust
    hostname: pakana-node
    ipc: host
    depends_on:
      - yottadb
    volumes:
      - yottadb-data:/data
    environment:
      - ydb_dir=/data
      - ydb_rel=r2.03_x86_64
      - ydb_gbldir=/data/r2.03_x86_64/g/yottadb.gld
      - ydb_routines=/data/r2.03_x86_64/o/utf8 /data/r2.03_x86_64/r /data/r2.03_x86_64/o /opt/yottadb/current/plugin/o/utf8 /opt/yottadb/current/plugin/r /opt/yottadb/current/plugin/o
      - ydb_ci=/opt/yottadb/current/plugin/octo/ydbocto.ci
      - ydb_dist=/opt/yottadb/current
      - LD_LIBRARY_PATH=/opt/yottadb/current
      - RUST_LOG=info
      - ydb_nodename=pakana-node
      - ydb_tmp=/data/tmp
      - GTM_TMP=/data/tmp
    restart: always

  api-report:
    build:
      context: ../api-report
    container_name: pakana-api-report
    hostname: pakana-node
    depends_on:
      - yottadb
    ports:
      - "127.0.0.1:8080:8080"
    ipc: host
    volumes:
      - yottadb-data:/data
    environment:
      - ydb_dir=/data
      - ydb_rel=r2.03_x86_64
      - ydb_gbldir=/data/r2.03_x86_64/g/yottadb.gld
      - ydb_routines=/data/r2.03_x86_64/o/utf8 /data/r2.03_x86_64/r /data/r2.03_x86_64/o /opt/yottadb/current/plugin/o/utf8 /opt/yottadb/current/plugin/r /data/r2.03_x86_64/o /opt/yottadb/current/libyottadbutil.so /opt/yottadb/current/libyottadb.so /opt/yottadb/current
      - ydb_dist=/opt/yottadb/current
      - LD_LIBRARY_PATH=/opt/yottadb/current
      - ydb_nodename=pakana-node
      - ydb_tmp=/data/tmp
      - GTM_TMP=/data/tmp
      - PORT=8080
      - API_KEY=${PAKANA_API_KEY:-changeme}
      - HORIZON_URL=https://horizon-testnet.stellar.org
    restart: always

  reverse-proxy:
    image: caddy:2-alpine
    container_name: pakana-reverse-proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ../docs:/data/docs:ro
      - caddy-data:/data
      - caddy-config:/config
    environment:
      - DOMAIN_NAME=${DOMAIN_NAME:-${PAKANA_DOMAIN:-build.lockb0x.dev}}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-${PAKANA_EMAIL:-steven@thefirm.codes}}
      - PAKANA_STAGING=${PAKANA_STAGING:-false}
      - PAKANA_ACME_CA=${PAKANA_ACME_CA:-https://acme-v02.api.letsencrypt.org/directory}
    depends_on:
      - api-report

volumes:
  yottadb-data:
  caddy-data:
  caddy-config:


